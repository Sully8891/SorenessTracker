<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">

    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0f172a"> <title>Daily Muscle Tracker</title>

    <script src="https://cdn.tailwindcss.com" defer></script>

    <style>
      /* Base body styling - Permanent Dark Theme */
      body {
          font-family: sans-serif;
          overscroll-behavior-y: contain;
          @apply bg-slate-900 text-gray-200;
          margin: 0; /* Ensure no default margin */
      }

      /* Main container */
      .main-container {
           max-width: 56rem; margin-left: auto; margin-right: auto;
           background-color: #1e293b; /* slate-800 */
           border-radius: 0; /* No rounding on mobile */
           box-shadow: none; /* No shadow on mobile */
           padding: 0.75rem; /* p-3 */
           min-height: 100vh; /* Ensure it takes full height */
           box-sizing: border-box;
      }
      @media (min-width: 768px) { /* Apply card styles only on larger screens */
          .main-container {
             border-radius: 0.75rem; /* rounded-xl */
             box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* shadow-lg */
             padding: 2rem; /* md:p-8 */
             margin-top: 1rem; margin-bottom: 1rem;
             min-height: auto;
          }
      }

      /* Header */
      .header-flex { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; flex-wrap: wrap; gap: 0.5rem; }
      .header-title { font-size: 1.5rem; line-height: 2rem; font-weight: 700; color: #f3f4f6; }

      /* Add Muscle Section */
      .add-muscle-section { display: flex; gap: 0.5rem; margin-bottom: 1rem; padding-left: 0.25rem; padding-right: 0.25rem; }
      #new-muscle-input {
          flex-grow: 1; padding: 0.5rem; border-width: 1px; border-color: #475569; background-color: #334155;
          color: #f3f4f6; border-radius: 0.375rem;
      }
      #new-muscle-input::placeholder { color: #9ca3af; }
      #new-muscle-input:focus { outline: 2px solid transparent; outline-offset: 2px; box-shadow: 0 0 0 2px #3b82f6; }
      #add-muscle-btn {
          padding-left: 1rem; padding-right: 1rem; padding-top: 0.5rem; padding-bottom: 0.5rem;
          background-color: #15803d; color: white; font-weight: 600; border-radius: 0.375rem;
          box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      }
      #add-muscle-btn:hover { background-color: #166534; }
      #add-muscle-btn:focus { outline: 2px solid transparent; outline-offset: 2px; box-shadow: 0 0 0 2px #22c55e, 0 0 0 4px #1e293b; }

      /* Reset Button */
       #reset-button {
           padding-left: 1rem; padding-right: 1rem; padding-top: 0.5rem; padding-bottom: 0.5rem;
           background-color: #dc2626; color: white; font-weight: 600; border-radius: 0.5rem;
           box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
       }
       #reset-button:hover { background-color: #b91c1c; }
       #reset-button:focus { outline: 2px solid transparent; outline-offset: 2px; box-shadow: 0 0 0 2px #f87171, 0 0 0 4px #1e293b; }

      /* Legend */
      .legend-container {
          margin-top: 2rem; padding-top: 1rem; border-top-width: 1px; border-color: #334155;
          font-size: 0.875rem; line-height: 1.25rem; color: #9ca3af; display: flex;
          flex-wrap: wrap; justify-content: center; gap: 1rem;
      }
      .legend-item { display: flex; align-items: center; }
      .legend-emoji { font-size: 1.25rem; margin-right: 0.25rem; }
      .legend-swatch-worked { display: inline-block; width: 1rem; height: 1rem; border: 1px solid #64748b; margin-right: 0.25rem; border-radius: 50%; position: relative; background-color: transparent; }
      .legend-swatch-worked::after { content: ''; position: absolute; top: 2px; left: 2px; right: 2px; bottom: 2px; border-radius: 50%; background-color: #0ea5e9; }

      /* --- Landscape Table Styles --- */
       .tracker-table { width: 100%; border-collapse: collapse; table-layout: fixed; }
       .tracker-table th, .tracker-table td {
           text-align: center; padding: 0; border: 1px solid #64748b; /* slate-500 */
           vertical-align: middle; position: relative;
       }
       .tracker-table th {
           background-color: rgba(51, 65, 85, 0.5); font-weight: 600; font-size: 0.875rem;
           color: #d1d5db; white-space: nowrap; padding: 0.5rem 0.25rem;
       }
       .tracker-table th:first-child,
       .tracker-table td:first-child {
           position: sticky; left: 0; z-index: 10; background-color: #1e293b; /* slate-800 */
           text-align: left; font-weight: 500; color: #f3f4f6; width: 150px;
           border-color: #64748b;
       }
       .tracker-table th:first-child { z-index: 11; }
       .tracker-table tbody tr:nth-child(even) { background-color: rgba(255, 255, 255, 0.05); }
       .tracker-table tbody tr:nth-child(even) td:first-child { background-color: #334155; border-color: #64748b; }

       /* Container within the table cell */
       .cell-content-container {
           padding: 0.25rem; min-height: 50px; display: flex;
           align-items: center; justify-content: center; position: relative;
           z-index: 1; transition: background-color 0.2s ease-in-out;
           background-color: transparent;
       }
       .tracker-table td:first-child .cell-content-container {
           justify-content: flex-start; padding-left: 0.75rem; cursor: default;
           background-color: transparent !important;
       }
       .cell-content-container.worked-out { background-color: #1d4ed8 !important; } /* blue-700 */

       /* Emoji and Workout Toggle Styles (Shared by both layouts) */
      .status-emoji {
        cursor: pointer; padding: 0.25rem; border-radius: 0.375rem;
        transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out;
        font-size: 1.5rem; line-height: 1; display: inline-flex; align-items: center;
        justify-content: center; width: 40px; height: 40px; border: 1px solid transparent;
        background-color: transparent; position: relative; z-index: 2;
      }
      .status-emoji:hover { transform: scale(1.1); background-color: rgba(255, 255, 255, 0.1); }
      .status-emoji:active { transform: scale(0.95); }

      .workout-toggle-btn {
           /* Shared styles for the button itself */
           width: 32px; /* Slightly larger tap target */
           height: 32px;
           border-radius: 50%; cursor: pointer; border: 1px solid #64748b;
           background-color: transparent; display: flex; align-items: center;
           justify-content: center; z-index: 3; transition: background-color 0.2s ease;
       }
       .workout-toggle-btn:hover { background-color: rgba(255, 255, 255, 0.1); }
       .workout-toggle-btn .inner-circle {
           width: 14px; height: 14px; border-radius: 50%;
           background-color: transparent; transition: background-color 0.2s ease;
       }
       .workout-toggle-btn.active .inner-circle { background-color: #0ea5e9; /* sky-500 */ }
       .workout-toggle-btn.active { border-color: #38bdf8; /* sky-400 */ }

       /* Table specific workout toggle position */
       .tracker-table .workout-toggle-btn {
           position: absolute;
           top: 2px;
           right: 2px;
       }
       .tracker-table .emoji-container { /* Container for emoji in table */
           /* Centered by flex in cell-content-container */
       }

       /* Drag and Drop Styles (Apply only to table rows) */
       .tracker-table .drag-handle {
           cursor: grab; display: inline-block; margin-right: 8px; color: #6b7280;
           padding: 10px 5px; touch-action: none; vertical-align: middle;
       }
       .tracker-table .muscle-name-text { flex-grow: 1; vertical-align: middle; }
       .tracker-table .muscle-row.dragging { opacity: 0.6; background-color: #1e1b4b !important; }
       .tracker-table .muscle-row.dragging td { background-color: #1e1b4b !important; }
       .tracker-table .muscle-row.dragging td:first-child { background-color: #312e81 !important; }
       .tracker-table .drag-over { border-top: 2px dashed #60a5fa; }

       /* Swipe Styles (Apply only to table rows) */
       .tracker-table .muscle-row td { overflow: hidden; }
       .tracker-table .delete-indicator {
           position: absolute; top: 0; right: 0; bottom: 0; width: 80px;
           background-color: #9f1239; color: white; display: flex; align-items: center;
           justify-content: center; font-weight: bold; z-index: 0; opacity: 0;
           transition: opacity 0.2s ease-in-out; pointer-events: none;
       }
       .tracker-table .muscle-row.swiping .delete-indicator { opacity: 1; }
       .tracker-table .muscle-row .cell-content-container { transition: transform 0.1s ease-out; width: 100%; height: 100%; }
       .tracker-table .muscle-row.swiping .cell-content-container { transition: none; background-color: rgba(159, 18, 57, 0.7) !important; }
       .tracker-table td:first-child .cell-content-container { transform: none !important; background-color: transparent !important; }

      /* --- Portrait View Styles --- */
      #portrait-view-container { display: none; /* Hidden by default */ }
      .portrait-day-nav {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 1rem; /* mb-4 */
          padding: 0.5rem;
          background-color: #334155; /* slate-700 */
          border-radius: 0.375rem; /* rounded-md */
      }
      .portrait-day-nav button {
          background: none; border: none; color: #cbd5e1; /* slate-300 */
          font-size: 1.5rem; cursor: pointer; padding: 0 0.5rem;
      }
       .portrait-day-nav button:hover { color: #f1f5f9; /* slate-100 */ }
      .portrait-day-nav h2 {
          font-size: 1.125rem; /* text-lg */
          font-weight: 600; /* font-semibold */
          color: #f1f5f9; /* slate-100 */
      }
      .portrait-muscle-list { list-style: none; padding: 0; margin: 0; }
      .portrait-muscle-item {
          display: flex;
          align-items: center;
          justify-content: space-between;
          padding: 0.75rem 0.5rem; /* py-3 px-2 */
          border-bottom: 1px solid #475569; /* slate-600 */
      }
      .portrait-muscle-item:last-child { border-bottom: none; }
      .portrait-muscle-name {
          font-weight: 500;
          flex-grow: 1;
          margin-right: 1rem;
      }
      .portrait-controls {
          display: flex;
          align-items: center;
          gap: 0.75rem; /* space-x-3 */
      }
      /* Adjust workout toggle position for portrait */
      .portrait-controls .workout-toggle-btn {
          position: relative; /* Not absolute */
          top: auto; right: auto;
      }

      /* --- Media Query for Portrait / Narrow Screens --- */
      /* Adjust breakpoint as needed, 768px is common for tablets */
      @media (orientation: portrait) and (max-width: 767px), (max-width: 480px) {
          #landscape-view-container { display: none; }
          #portrait-view-container { display: block; }
          .table-scroll-container { overflow-x: visible; } /* Disable horizontal scroll for table container */
          .main-container { padding: 0.5rem; } /* Reduce padding */
      }
      /* --- Media Query for Landscape / Wider Screens --- */
      @media (orientation: landscape), (min-width: 768px) {
          #landscape-view-container { display: block; }
          #portrait-view-container { display: none; }
      }

    </style>

</head>
<body class="bg-slate-900 text-gray-200">

    <div class="main-container">
        <div class="overflow-x-hidden">
             <div class="header-flex">
                <h1 class="header-title">Weekly Muscle Soreness Tracker</h1>
            </div>

            <div class="add-muscle-section">
                <input type="text" id="new-muscle-input" placeholder="Enter new muscle group">
                <button id="add-muscle-btn">Add</button>
            </div>

            <div id="landscape-view-container">
                <div class="table-scroll-container">
                    <div id="tracker-container-landscape">
                        </div>
                </div>
            </div>

            <div id="portrait-view-container">
                <div class="portrait-day-nav">
                    <button id="prev-day-btn">&lt;</button>
                    <h2 id="current-day-display">Monday</h2>
                    <button id="next-day-btn">&gt;</button>
                </div>
                <ul id="tracker-container-portrait" class="portrait-muscle-list">
                    </ul>
            </div>


            <div class="text-center mt-6">
                 <button id="reset-button">
                     Reset All Statuses
                 </button>
            </div>

            <div class="legend-container">
                <div class="legend-item"><span class="legend-emoji">🔥</span> Sore</div>
                <div class="legend-item"><span class="legend-emoji">✅</span> Healed</div>
                <div class="legend-item"><span class="legend-emoji">➖</span> No Effect</div>
                <div class="legend-item"><span class="legend-emoji">⚪</span> Untracked</div>
                <div class="legend-item"><span class="legend-swatch-worked"></span> Worked Out</div>
            </div>
        </div>
    </div>

    <script>
        console.log("Script start - Responsive Layout");

        // --- State Definitions ---
        let muscleGroups = [];
        const defaultMuscleGroups = [ 'Pectorals', 'Biceps', 'Triceps', 'Delts', 'Lats', 'Mid Back', 'Quads', 'Hamstrings', 'Calves', 'Glutes', 'Forearms' ];
        const daysOfWeek = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
        const states = { sore: '🔥', healed: '✅', no_effect: '➖', untracked: '⚪' };
        const stateKeys = Object.keys(states);
        const stateIntMap = { untracked: 0, sore: 1, healed: 2, no_effect: 3 };
        const intStateMap = { 0: 'untracked', 1: 'sore', 2: 'healed', 3: 'no_effect' };

        // --- Current Day for Portrait View ---
        // Default to current day, or Monday if Sunday (0)
        let currentDayIndex = (new Date().getDay() + 6) % 7; // 0=Mon, 1=Tue, ..., 6=Sun

        // --- LocalStorage Interaction ---
        const MUSCLE_LIST_KEY = 'muscleTracker_muscleList_v2';
        const STATUS_KEY_PREFIX = 'muscleTracker_status_pwa_v2_';
        const WORKOUT_KEY_PREFIX = 'muscleTracker_workout_pwa_v2_';

        function getStatusStorageKey(muscle, day) { const m = muscle.replace(/\s+/g, '_').toLowerCase(); return `${STATUS_KEY_PREFIX}${m}_${day.toLowerCase()}`; }
        function getStatus(muscle, day) { const i = localStorage.getItem(getStatusStorageKey(muscle, day)); return intStateMap[i] || 'untracked'; }
        function setStatus(muscle, day, statusKey) { const k = getStatusStorageKey(muscle, day); const i = stateIntMap[statusKey]; if (statusKey === 'untracked') localStorage.removeItem(k); else localStorage.setItem(k, i); }
        function getWorkoutStorageKey(muscle, day) { const m = muscle.replace(/\s+/g, '_').toLowerCase(); return `${WORKOUT_KEY_PREFIX}${m}_${day.toLowerCase()}`; }
        function getWorkoutStatus(muscle, day) { return localStorage.getItem(getWorkoutStorageKey(muscle, day)) === '1'; }
        function setWorkoutStatus(muscle, day, workedOut) { const key = getWorkoutStorageKey(muscle, day); if (workedOut) { localStorage.setItem(key, '1'); } else { localStorage.removeItem(key); } /* UI update handled by render or specific update */ }
        function loadMuscleGroups() { const s = localStorage.getItem(MUSCLE_LIST_KEY); if (s) { try { const p = JSON.parse(s); if (Array.isArray(p) && p.every(m => typeof m === 'string')) { muscleGroups = p; } else { throw new Error("Invalid"); } } catch (e) { console.warn("Using default muscles.", e); muscleGroups = [...defaultMuscleGroups]; saveMuscleGroups(); } } else { muscleGroups = [...defaultMuscleGroups]; } }
        function saveMuscleGroups() { localStorage.setItem(MUSCLE_LIST_KEY, JSON.stringify(muscleGroups)); }

        // --- UI Update Functions ---

        // Main render function - decides which view to show
        function renderApp() {
            console.log("renderApp called");
            // Simple check: Use portrait if window width is less than height or less than 768px
            const isPortrait = window.matchMedia("(orientation: portrait)").matches || window.innerWidth < 768;
            console.log("Is Portrait?", isPortrait);

            if (isPortrait) {
                renderPortraitView();
            } else {
                renderLandscapeView();
            }
            // Ensure correct containers are shown/hidden (CSS should handle this, but JS can force it)
            const landscapeContainer = document.getElementById('landscape-view-container');
            const portraitContainer = document.getElementById('portrait-view-container');
            if (landscapeContainer && portraitContainer) {
                landscapeContainer.style.display = isPortrait ? 'none' : 'block';
                portraitContainer.style.display = isPortrait ? 'block' : 'none';
            }
        }

        // Renders the Landscape Table View
        function renderLandscapeView() {
            console.log("Rendering Landscape View");
            const container = document.getElementById('tracker-container-landscape');
            if (!container) { console.error("Landscape container not found!"); return; }
            container.innerHTML = ''; // Clear previous

            const table = document.createElement('table');
            table.className = 'tracker-table';
            const thead = table.createTHead();
            const headerRow = thead.insertRow();
            const thMuscle = document.createElement('th'); thMuscle.textContent = 'Muscle'; headerRow.appendChild(thMuscle);
            daysOfWeek.forEach(day => { const thDay = document.createElement('th'); thDay.textContent = day; headerRow.appendChild(thDay); });

            const tbody = table.createTBody();
            if (muscleGroups.length === 0) {
                 const row = tbody.insertRow(); const cell = row.insertCell(); cell.colSpan = daysOfWeek.length + 1;
                 cell.textContent = "No muscle groups added yet."; cell.className = 'text-center text-gray-400 py-4';
            } else {
                muscleGroups.forEach((muscle, index) => {
                    const row = tbody.insertRow();
                    row.className = 'muscle-row';
                    row.setAttribute('draggable', 'true');
                    row.dataset.muscleIndex = index; row.dataset.muscleName = muscle;

                    // Add event listeners (drag/swipe)
                    row.addEventListener('dragstart', handleDragStart); row.addEventListener('dragover', handleDragOver); row.addEventListener('dragenter', handleDragEnter); row.addEventListener('dragleave', handleDragLeave); row.addEventListener('drop', handleDrop); row.addEventListener('dragend', handleDragEnd);
                    row.addEventListener('touchstart', handleTouchStart, { passive: false }); row.addEventListener('touchmove', handleTouchMove, { passive: false }); row.addEventListener('touchend', handleTouchEnd); row.addEventListener('touchcancel', handleTouchEnd);

                    const cellMuscle = row.insertCell(); cellMuscle.classList.add('relative');
                    const muscleWrapper = document.createElement('div'); muscleWrapper.className = 'cell-content-container first-cell-wrapper';
                    muscleWrapper.innerHTML = `<span class="drag-handle">☰</span><span class="muscle-name-text">${escapeHtml(muscle)}</span>`;
                    cellMuscle.appendChild(muscleWrapper);
                    const deleteIndicator = document.createElement('div'); deleteIndicator.className = 'delete-indicator'; deleteIndicator.textContent = 'Delete'; cellMuscle.appendChild(deleteIndicator);

                    daysOfWeek.forEach(day => {
                        const cell = row.insertCell(); cell.classList.add('relative');
                        const muscleKey = muscle.replace(/\s+/g, '_').toLowerCase(); const dayKey = day.toLowerCase();
                        cell.id = `cell-land-${muscleKey}-${dayKey}`; // Unique ID for landscape cell
                        const cellWrapper = document.createElement('div'); cellWrapper.className = 'cell-content-container';
                        cell.appendChild(cellWrapper);

                        const workoutButton = document.createElement('button'); workoutButton.className = 'workout-toggle-btn';
                        workoutButton.innerHTML = '<span class="inner-circle"></span>';
                        workoutButton.setAttribute('aria-label', `Toggle workout status for ${escapeHtml(muscle)} on ${day}`);
                        workoutButton.dataset.muscle = muscle; workoutButton.dataset.day = day;
                        workoutButton.addEventListener('click', handleWorkoutToggle);
                        cellWrapper.appendChild(workoutButton);

                        const emojiContainer = document.createElement('div'); emojiContainer.className = 'emoji-container';
                        cellWrapper.appendChild(emojiContainer);

                        requestAnimationFrame(() => { updateCellEmoji(muscle, day, 'land'); updateCellWorkoutStatus(muscle, day, 'land'); });
                    });
                });
            }
            container.appendChild(table);
        }

        // Renders the Portrait Day-by-Day List View
        function renderPortraitView() {
            console.log(`Rendering Portrait View for day index: ${currentDayIndex}`);
            const container = document.getElementById('tracker-container-portrait');
            const dayDisplay = document.getElementById('current-day-display');
            if (!container || !dayDisplay) { console.error("Portrait container or day display not found!"); return; }
            container.innerHTML = ''; // Clear previous list

            const currentDay = daysOfWeek[currentDayIndex];
            dayDisplay.textContent = currentDay; // Update day name display

            if (muscleGroups.length === 0) {
                 container.innerHTML = `<li class="text-center text-gray-400 py-4">No muscle groups added yet.</li>`;
            } else {
                muscleGroups.forEach((muscle) => {
                    const li = document.createElement('li');
                    li.className = 'portrait-muscle-item';
                    // Note: Drag/Drop and Swipe-to-delete are NOT implemented for this view for simplicity
                    // Could be added by attaching listeners here if needed

                    const nameSpan = document.createElement('span');
                    nameSpan.className = 'portrait-muscle-name';
                    nameSpan.textContent = escapeHtml(muscle);

                    const controlsDiv = document.createElement('div');
                    controlsDiv.className = 'portrait-controls';

                    // Workout Toggle Button
                    const workoutButton = document.createElement('button');
                    workoutButton.className = 'workout-toggle-btn'; // Use shared style
                    workoutButton.innerHTML = '<span class="inner-circle"></span>';
                    workoutButton.setAttribute('aria-label', `Toggle workout status for ${escapeHtml(muscle)} on ${currentDay}`);
                    workoutButton.dataset.muscle = muscle;
                    workoutButton.dataset.day = currentDay; // Use currentDay
                    workoutButton.addEventListener('click', handleWorkoutToggle);
                    controlsDiv.appendChild(workoutButton);

                    // Soreness Status Emoji
                    const emojiSpan = document.createElement('span');
                    emojiSpan.className = 'status-emoji'; // Use shared style
                    emojiSpan.setAttribute('aria-label', `Cycle soreness status for ${escapeHtml(muscle)} on ${currentDay}`);
                    emojiSpan.dataset.muscle = muscle;
                    emojiSpan.dataset.day = currentDay; // Use currentDay
                    const currentStatusKey = getStatus(muscle, currentDay);
                    const currentStateInt = stateIntMap[currentStatusKey];
                    emojiSpan.textContent = states[currentStatusKey];
                    emojiSpan.addEventListener('click', (event) => {
                        // Need to pass the correct state int when cycling
                        cycleStatus(event, muscle, currentDay, currentStateInt);
                    });
                    controlsDiv.appendChild(emojiSpan);

                    li.appendChild(nameSpan);
                    li.appendChild(controlsDiv);
                    container.appendChild(li);

                    // Update the button state after adding to DOM
                    requestAnimationFrame(() => {
                         updateCellWorkoutStatus(muscle, currentDay, 'port'); // Update button state
                    });
                });
            }
        }


        // Update UI functions now accept an optional view type ('land' or 'port')
        // to potentially target different elements if needed, though currently they rely on unique IDs or context
        function updateCellEmoji(muscle, day, view = 'land') {
            const muscleKey = muscle.replace(/\s+/g, '_').toLowerCase();
            const dayKey = day.toLowerCase();
            const currentStatusKey = getStatus(muscle, day);
            const currentStateInt = stateIntMap[currentStatusKey];

            let emojiSpan;
            if (view === 'land') {
                const cell = document.getElementById(`cell-land-${muscleKey}-${dayKey}`);
                const emojiContainer = cell?.querySelector('.emoji-container');
                if (!emojiContainer) return;
                emojiContainer.innerHTML = ''; // Clear previous
                emojiSpan = document.createElement('span');
                emojiSpan.className = 'status-emoji';
                emojiSpan.addEventListener('click', (event) => { event.stopPropagation(); cycleStatus(event, muscle, day, currentStateInt); });
                emojiContainer.appendChild(emojiSpan);
            } else { // Portrait view
                // Find the list item and the emoji span within it
                 const listItem = Array.from(document.querySelectorAll('#tracker-container-portrait li')).find(li => li.querySelector(`.portrait-muscle-name`)?.textContent === muscle);
                 emojiSpan = listItem?.querySelector('.status-emoji');
                 if (!emojiSpan) return;
                 // Update existing span
            }

            emojiSpan.textContent = states[currentStatusKey];
            emojiSpan.setAttribute('aria-label', `${escapeHtml(muscle)} on ${day} is ${currentStatusKey.replace('_', ' ')}`);
            // Ensure data attributes are updated if needed for cycling
            emojiSpan.dataset.muscle = muscle;
            emojiSpan.dataset.day = day;
            // Re-attach listener with updated state (important for portrait view)
             if (view === 'port') {
                 // Remove old listener before adding new one to prevent duplicates
                 emojiSpan.replaceWith(emojiSpan.cloneNode(true)); // Simple way to remove listeners
                 emojiSpan = document.querySelector(`#tracker-container-portrait li span[data-muscle="${muscle}"] + .portrait-controls .status-emoji`); // Re-select the new node
                 if(emojiSpan) {
                     emojiSpan.addEventListener('click', (event) => {
                         cycleStatus(event, muscle, day, currentStateInt);
                     });
                 }
             }
        }

        function updateCellWorkoutStatus(muscle, day, view = 'land') {
             const workedOut = getWorkoutStatus(muscle, day);
             let workoutButton;

             if (view === 'land') {
                 const muscleKey = muscle.replace(/\s+/g, '_').toLowerCase();
                 const dayKey = day.toLowerCase();
                 const cell = document.getElementById(`cell-land-${muscleKey}-${dayKey}`);
                 workoutButton = cell?.querySelector('.workout-toggle-btn');
             } else { // Portrait view
                 const listItem = Array.from(document.querySelectorAll('#tracker-container-portrait li')).find(li => li.querySelector(`.portrait-muscle-name`)?.textContent === muscle);
                 workoutButton = listItem?.querySelector('.workout-toggle-btn');
             }

             if (!workoutButton) return;
             workoutButton.classList.toggle('active', workedOut);
        }

        function escapeHtml(unsafe) { if (!unsafe) return ''; return unsafe.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;"); }

        // --- Event Handlers ---
        function cycleStatus(event, muscle, day, currentStateInt) {
            const currentStatusKey = intStateMap[currentStateInt];
            const currentIndex = stateKeys.indexOf(currentStatusKey);
            const nextIndex = (currentIndex + 1) % stateKeys.length;
            const nextStatusKey = stateKeys[nextIndex];
            setStatus(muscle, day, nextStatusKey); // Save new state

            // Re-render the appropriate view to update the clicked element
            renderApp();
        }

        function handleWorkoutToggle(event) {
            const muscle = this.dataset.muscle;
            const day = this.dataset.day;
            if (!muscle || !day) return;
            const currentWorkoutStatus = getWorkoutStatus(muscle, day);
            setWorkoutStatus(muscle, day, !currentWorkoutStatus); // Saves and calls updateCellWorkoutStatus

            // Re-render portrait view if active to ensure consistency, landscape updates via updateCellWorkoutStatus
             const isPortrait = window.matchMedia("(orientation: portrait)").matches || window.innerWidth < 768;
             if (isPortrait) {
                 renderPortraitView(); // Re-render list for the current day
             } else {
                 updateCellWorkoutStatus(muscle, day, 'land'); // Explicitly update landscape button
             }
        }

        function handleAddMuscle() { const input = document.getElementById('new-muscle-input'); const newMuscleName = input.value.trim(); if (newMuscleName === '') { alert('Please enter a muscle name.'); return; } if (muscleGroups.some(m => m.toLowerCase() === newMuscleName.toLowerCase())) { alert(`Muscle group "${escapeHtml(newMuscleName)}" already exists.`); return; } muscleGroups.push(newMuscleName); saveMuscleGroups(); renderApp(); input.value = ''; }
        function handleDeleteMuscle(muscleToDelete) { if (!muscleToDelete) return; daysOfWeek.forEach(day => { localStorage.removeItem(getStatusStorageKey(muscleToDelete, day)); localStorage.removeItem(getWorkoutStorageKey(muscleToDelete, day)); }); muscleGroups = muscleGroups.filter(m => m !== muscleToDelete); saveMuscleGroups(); renderApp(); } // Call renderApp
        function resetAllStatuses() { if (confirm('Are you sure you want to reset all statuses AND workout indicators for the week?')) { const keysToRemove = []; muscleGroups.forEach(muscle => { daysOfWeek.forEach(day => { keysToRemove.push(getStatusStorageKey(muscle, day)); keysToRemove.push(getWorkoutStorageKey(muscle, day)); }); }); keysToRemove.forEach(key => localStorage.removeItem(key)); renderApp(); } } // Call renderApp

        // --- Day Navigation Handlers ---
        function navigateDay(direction) {
            currentDayIndex = (currentDayIndex + direction + daysOfWeek.length) % daysOfWeek.length;
            renderPortraitView(); // Re-render portrait view for the new day
        }

        // --- Drag and Drop Handlers --- (Apply only in landscape)
        let draggedItem = null; let draggedItemIndex = -1; let isDragging = false;
        function handleDragStart(e) { const isPortrait = window.matchMedia("(orientation: portrait)").matches || window.innerWidth < 768; if (isPortrait || isSwiping || touchStartX !== null) { e.preventDefault(); return; } isDragging = true; draggedItem = this; draggedItemIndex = parseInt(this.dataset.muscleIndex, 10); e.dataTransfer.effectAllowed = 'move'; const dragImage = document.createElement('div'); dragImage.style.width = '1px'; dragImage.style.height = '1px'; dragImage.style.opacity = '0'; document.body.appendChild(dragImage); try { e.dataTransfer.setDragImage(dragImage, 0, 0); } catch (err) {} setTimeout(() => { draggedItem?.classList.add('dragging'); }, 0); }
        function handleDragOver(e) { const isPortrait = window.matchMedia("(orientation: portrait)").matches || window.innerWidth < 768; if (isPortrait || !isDragging) return; e.preventDefault(); e.dataTransfer.dropEffect = 'move'; const targetRow = e.target.closest('tr.muscle-row'); document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over')); if (targetRow && targetRow !== draggedItem) { targetRow.classList.add('drag-over'); } return false; }
        function handleDragEnter(e) { /* Combined */ }
        function handleDragLeave(e) { const isPortrait = window.matchMedia("(orientation: portrait)").matches || window.innerWidth < 768; if (isPortrait || !isDragging) return; const relatedTarget = e.relatedTarget; const targetRow = e.target.closest('tr.muscle-row'); if (targetRow && (!relatedTarget || !targetRow.contains(relatedTarget))) { targetRow.classList.remove('drag-over'); } }
        function handleDrop(e) { const isPortrait = window.matchMedia("(orientation: portrait)").matches || window.innerWidth < 768; if (isPortrait || !isDragging) return; e.preventDefault(); e.stopPropagation(); const targetRow = e.target.closest('tr.muscle-row'); document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over')); if (targetRow && draggedItem && targetRow !== draggedItem) { const targetIndex = parseInt(targetRow.dataset.muscleIndex, 10); if (draggedItemIndex !== -1 && targetIndex !== -1 && !isNaN(draggedItemIndex) && !isNaN(targetIndex)) { const itemToMove = muscleGroups.splice(draggedItemIndex, 1)[0]; muscleGroups.splice(targetIndex, 0, itemToMove); saveMuscleGroups(); renderApp(); } else { console.error("Drag/Drop index error", {draggedItemIndex, targetIndex}); } } const dragImage = document.querySelector('div[style*="width: 1px"]'); if (dragImage && dragImage.parentNode === document.body) document.body.removeChild(dragImage); handleDragEndCleanup(); return false; }
        function handleDragEnd(e) { handleDragEndCleanup(); }
        function handleDragEndCleanup() { if (!isDragging) return; document.querySelectorAll('.muscle-row').forEach(row => { row.classList.remove('dragging'); row.classList.remove('drag-over'); }); draggedItem = null; draggedItemIndex = -1; isDragging = false; }

        // --- Swipe Detection Handlers --- (Apply only in landscape)
        let touchStartX = null; let touchCurrentX = null; let touchStartY = null; let swipedRow = null; let isSwiping = false; const swipeThreshold = -75; const verticalScrollThreshold = 10;
        function handleTouchStart(e) { const isPortrait = window.matchMedia("(orientation: portrait)").matches || window.innerWidth < 768; if (isPortrait || isDragging || e.touches.length > 1 || e.target.closest('.status-emoji') || e.target.closest('.drag-handle') || e.target.closest('.workout-toggle-btn')) { return; } touchStartX = e.touches[0].clientX; touchStartY = e.touches[0].clientY; touchCurrentX = touchStartX; swipedRow = e.target.closest('tr.muscle-row'); isSwiping = false; if (swipedRow) swipedRow.setAttribute('draggable', 'false'); }
        function handleTouchMove(e) { const isPortrait = window.matchMedia("(orientation: portrait)").matches || window.innerWidth < 768; if (isPortrait || !touchStartX || isDragging || !swipedRow || e.touches.length > 1) return; touchCurrentX = e.touches[0].clientX; const currentY = e.touches[0].clientY; const diffX = touchCurrentX - touchStartX; const diffY = Math.abs(currentY - touchStartY); if (!isSwiping) { if (diffY > verticalScrollThreshold && diffY > Math.abs(diffX)) { resetSwipeState(); return; } if (Math.abs(diffX) > 10) { isSwiping = true; swipedRow.classList.add('swiping'); } } if (isSwiping) { e.preventDefault(); const translateX = Math.min(0, diffX); const wrappers = swipedRow.querySelectorAll('.cell-content-container:not(.first-cell-wrapper)'); wrappers.forEach(wrapper => { wrapper.style.transform = `translateX(${translateX}px)`; }); const firstCellWrapper = swipedRow.cells[0].querySelector('.cell-content-container'); if(firstCellWrapper) { firstCellWrapper.style.transform = `translateX(${translateX}px)`; } } }
        function handleTouchEnd(e) { const isPortrait = window.matchMedia("(orientation: portrait)").matches || window.innerWidth < 768; if (isPortrait || !swipedRow) { resetSwipeState(); return; } const wasSwiping = isSwiping; const diffX = touchCurrentX - touchStartX; const muscleToDelete = swipedRow.dataset.muscleName; const wrappers = swipedRow.querySelectorAll('.cell-content-container'); wrappers.forEach(wrapper => { wrapper.style.transform = 'translateX(0px)'; }); resetSwipeState(); if (wasSwiping && diffX < swipeThreshold) { setTimeout(() => { if (confirm(`Are you sure you want to delete "${escapeHtml(muscleToDelete)}"? This will also remove its status data.`)) { handleDeleteMuscle(muscleToDelete); } }, 50); } }
        function resetSwipeState() { if (swipedRow) { swipedRow.classList.remove('swiping'); const wrappers = swipedRow.querySelectorAll('.cell-content-container'); wrappers.forEach(wrapper => { wrapper.style.transform = 'translateX(0px)'; }); swipedRow.setAttribute('draggable', 'true'); } swipedRow = null; touchStartX = null; touchStartY = null; touchCurrentX = null; isSwiping = false; }

        // --- Debounce helper ---
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // --- App Initialization ---
        function initializeApp() {
            console.log("initializeApp start");
            loadMuscleGroups();
            renderApp(); // Initial render based on current orientation/size

            // Setup Add Button Listener
            const addButton = document.getElementById('add-muscle-btn');
            if (addButton) addButton.addEventListener('click', handleAddMuscle);
            else console.error("Add muscle button not found!");

            // Setup Reset Button Listener
            const resetButton = document.getElementById('reset-button');
             if (resetButton) resetButton.addEventListener('click', resetAllStatuses);
             else console.error("Reset button not found!");

             // Setup Portrait Day Navigation Listeners
             const prevDayBtn = document.getElementById('prev-day-btn');
             const nextDayBtn = document.getElementById('next-day-btn');
             if(prevDayBtn) prevDayBtn.addEventListener('click', () => navigateDay(-1));
             if(nextDayBtn) nextDayBtn.addEventListener('click', () => navigateDay(1));

             // Add listener for orientation/resize changes (debounced)
             window.addEventListener('resize', debounce(renderApp, 250));
             // Some mobile browsers might support orientationchange better
             window.addEventListener('orientationchange', debounce(renderApp, 250));


            console.log("initializeApp end");
        }

        // Initialize App and Register Service Worker
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            initializeApp();
        }

        if ('serviceWorker' in navigator) {
          window.addEventListener('load', () => {
            navigator.serviceWorker.register('/sw.js')
              .then(reg => console.log('ServiceWorker registration successful with scope: ', reg.scope))
              .catch(err => console.log('ServiceWorker registration failed: ', err));
          });
        } else {
            console.log('Service workers are not supported.');
        }

        console.log("Script end");
    </script>

</body>
</html>
